Міністерство освіти і науки України
Харківський національний університет радіоелектроніки

Катедра програмної інженерії



ЗВІТ
до лабораторної роботи № 3
з дисципліни «Аналіз та рефакторинґ коду»
на тему: «Розробка бізнес-логіки та функцій адміністрування серверної частини програмної системи»




     Виконала
     ст. гр. ПЗПІ-23-8
     Бут А. Ю.

     Перевірив
     асистент катедри ПІ
Дашенков Д. С.               



Харків 2025

1 ЗАВДАННЯ
     
     Ознайомитися з процесом розробки бізнес логіки та функцій адміністрування серверної частини програмної системи. Отримати практичні навички реалізації бізнес логіки, функцій адміністрування, створення UML-діаграм діяльності та взаємодії, а також перевірки (тестування) роботи серверної частини.
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

2 ОПИС ВИКОНАНОЇ РОБОТИ
     2.1 Бізнес логіка серверної частини програмної системи
     
     Серверна бізнес-логіка забезпечує виконання CRUD-операцій над даними, обробку HTTP-запитів від мобільного та веб-клієнтів, контроль доступу на основі ролей користувачів, обробку даних, отриманих від IoT-пристроїв, формування статистики, звітів і сповіщень, а також дотримання правил безпеки та цілісності даних. Усі запити до серверної частини проходять етапи автентифікації та авторизації, що дозволяє запобігти несанкціонованому доступу до ресурсів системи.
     Програмна реалізація серверної частини виконана мовою програмування Python з використанням фреймворку FastAPI.. Для доступу до бази даних використовується ORM-бібліотека SQLAlchemy, яка дозволяє працювати з реляційною базою даних PostgreSQL на рівні об’єктів, забезпечуючи зручність розробки та цілісність даних. Обмін даними між клієнтами та сервером здійснюється у форматі JSON відповідно до принципів REST-архітектури.
     Бізнес-логіка системи реалізує функціональні можливості залежно від ролі користувача. 
     Адміністратор системи:
* повний доступ до всіх ресурсів і даних системи;
* додавання, редагування та видалення користувачів і організацій;
* блокування облікових записів у разі порушень;
* керування та контроль IoT-пристроїв;
* формування звітів про обсяги зібраного та відсортованого сміття;
* аналіз статистики активності користувачів.
     Комунальна служба:
* моніторинг рівня заповнення контейнерів у реальному часі;
* перегляд історії вивозів сміття;
* отримання сповіщень про переповнення або несправності контейнерів;
* формування звітів за районами, типами відходів і частотою збору;
* аналіз статистики щодо вивезення відходів;
* формування актів виконаних робіт;
* управління транспортом, контейнерами та контейнерними майданчиками.
     Приватні компанії
* реєстрація та авторизація в системі;
* редагування даних облікового запису;
* подання заявок на прийом і переробку відходів;
* облік операцій з утилізації;
* перегляд статистики щодо типів і кількості відходів за періодами.
     Побутовий користувач
* перегляд станцій сортування відходів у межах міста та типом відходів;
* перегляд статусу контейнерів (рівень заповнення);
* отримання сповіщень про вивіз сміття 
* отримання порад про правила роздільного збору;
     Таким чином, розроблена бізнес-логіка серверної частини програмної системи Ecofy забезпечує чітке розмежування прав доступу, підтримує ключові бізнес-процеси системи.

     2.2 UML діаграми діяльності та послідовності
     
     Діаграма діяльності використовується для візуалізації процесу виконання дій у системі та ілюструє послідовний потік керування від однієї дії до іншої. Вона дозволяє наочно відобразити алгоритми роботи системи, умови переходів між етапами та можливі альтернативні сценарії.
     Діаграма послідовності відображає взаємодію між процесами або об’єктами під час виконання конкретного сценарію, показуючи порядок обміну повідомленнями між учасниками та логіку їхньої взаємодії в часі.
     Спочатку для опису бізнес-логіки серверної частини програмної системи Ecofy було розроблено UML-діаграми діяльності, які відображають алгоритми обробки основних серверних процесів. Зокрема, діаграми демонструють логіку реєстрації та авторизації користувачів (див. рис. 2.1), обробку заявок на вивіз відходів (див. рис. 2.2), а також взаємодію серверної частини з IoT-пристроями з метою автоматичного моніторингу стану контейнерів і ініціювання процесу вивозу відходів (див. рис. 2.3).

Рисунок 2.1 – Діаграма діяльності: реєстрація та авторизація

Рисунок 2.2 – Діаграма діяльності: обробка заявки на вивіз

Рисунок 2.3 – Діаграма діяльності: IoT на вивіз


     UML діаграма послідовності на рисунку 2.4 відображає процеси реєстрації та авторизації користувачів у серверній частині системи Ecofy, а також механізм контролю доступу до захищених ресурсів на основі ролей. У діаграмі враховано альтернативні та негативні сценарії, зокрема спроби входу з некоректними обліковими даними та виконання операцій без належних прав доступу. 
     

Рисунок 2.4 – Діаграма послідовності: реєстрація, авторизація та контроль доступу
     UML діаграма послідовності на рис. 2.5 відображає послідовність обміну повідомленнями між IoT-пристроями, серверною частиною системи Ecofy, базою даних та комунальною службою під час моніторингу стану контейнерів і виконання вивозу відходів.
     

Рисунок 2.5 –  Діаграма послідовності: IoT-моніторинг та вивіз сміття
     UML діаграма взаємодії на рисунку 2.6 відображає процес подання заявки на вивіз відходів у серверній частині системи Ecofy. Серверна бізнес-логіка виконує перевірку автентифікації та ролі користувача, валідацію даних заявки, збереження інформації в базі даних і сповіщення комунальної служби.
     

Рисунок 2.6 – Діаграма послідовності: подання заявки на вивіз сміття

     Розроблені UML діаграми діяльності та послідовності забезпечують цілісне уявлення про бізнес-логіку серверної частини програмної системи Ecofy. Вони демонструють основні алгоритми обробки запитів, взаємодію серверних компонентів і зовнішніх пристроїв, а також враховують альтернативні та негативні сценарії виконання процесів.
     2.3 Програмна реалізація адміністрування серверної частини програмної системи
     
     У серверній частині програмної системи Ecofy реалізовано функції адміністрування, що забезпечують централізоване управління користувачами, організаціями та системними ресурсами.
     Адміністратор системи має можливість переглядати перелік усіх користувачів, блокувати або видаляти облікові записи, переглядати клієнтські компанії, видаляти їх у разі порушення правил користування, створювати, блокувати та видаляти організації, а також переглядати та видаляти сповіщення.
     Доступ до адміністративних функцій обмежений за ролями та контролюється на рівні серверної логіки. .Визначення поточного користувача відбувається за допомогою функції get_current_user (див. Додаток Б.1), перехоплюючи HTTP-запити та перевіряючи JWT-токен.
     Також у відповідних API-ендпоінтах реалізовано перевірку ролі користувача з метою забезпечення ізоляції даних та запобігання несанкціонованому доступу:
      
1 if role == "organization":
2 query = query.join(ContainerSite).filter(
ContainerSite.organization_id == entity.organization_id
3 )
4 elif role != "admin":
5 raise HTTPException(403, "Access denied")
     
     У наведеному фрагменті коду адміністратор має доступ до повного переліку операцій у системі, а комунальна служба може переглядати лише ті записи, що пов’язані з контейнерними майданчиками, які належать саме їй.
     Окрім цього адміністратор може слідкувати за активністю користувачів системи, а саме за комунальними службами та приватними компаніями (див. Додаток Б.2 та Б.3.)

     2.4 Програмна реалізація бізнес логіки 

     У межах цього етапу було реалізовано бізнес-логіку серверної частини програмної системи Ecofy, яка забезпечує обробку запитів від клієнтів, взаємодію з базою даних та виконання основних функціональних сценаріїв відповідно до ролей користувачів.
     Побутові користувачі системи Ecofy мають можливість реєструватися та авторизуватися, переглядати й оновлювати інформацію свого профілю, отримувати дані про станції сортування відповідно до місця розташування та типів відходів, а також отримувати сповіщення про контейнерні майданчики, заплановані й виконані вивози сміття.
     Муніципальні та комунальні служби використовують систему для операційного управління процесами збору й вивозу сміття. Серверна бізнес-логіка надає їм можливість управляти контейнерами, контейнерними майданчиками, транспортними засобами та процесами вивозу відходів, приймати заявки на утилізацію, оновлювати їх статуси, а також формувати звітність і акти виконаних робіт. Окремо реалізовано механізм автоматичного формування акта приймання-передачі відходів (див. Додаток Б.4), який створюється після підтвердження виконання вивозу та містить інформацію про тип і обсяг відходів, дату виконання та відповідальні сторони.
     Приватні компанії можуть реєструватися в системі, переглядати та редагувати інформацію про свою діяльність, подавати заявки на вивіз або прийом відходів, а також отримувати підтверджувальні документи у вигляді актів приймання-передачі (див. Додаток Б.4), які використовуються для подальшого обліку та звітності.





     2.5 Перевірити роботу серверної частини системи:
     
     З метою перевірки коректності реалізації серверної частини програмної системи Ecofy було проведено тестування розроблених функцій бізнес-логіки та адміністрування. Перевірка здійснювалася з використанням документації Swagger (OpenAPI), а також шляхом аналізу логів виконання HTTP-запитів у середовищі Visual Studio Code.
     Під час тестування було перевірено працездатність усіх основних endpoint-ів, реалізованих для різних ролей користувачів системи, зокрема побутових користувачів, адміністраторів, організацій та клієнтських компаній.
     На рисунку 2.7 наведено перелік endpoint-ів, доступних для побутового користувача.  Результати виконання відповідних HTTP-запитів підтверджуються коректними кодами відповіді сервера (200 OK), що зафіксовано у логах сервера (рисунок 2.8).

Рисунок 2.7 – Endpoints для Users


Рисунок 2.8 – Перевірка роботи для Users
     На рисунках 2.9–2.10 представлено endpoint-и, призначені для адміністративного управління системою. У межах тестування перевірено:
* перегляд клієнтських компаній;
* блокування та видалення клієнтських компаній;
* створення, блокування та видалення організацій;
* перегляд та видалення сповіщень.
     Усі адміністративні операції виконувалися успішно та супроводжувалися відповідними HTTP-кодами відповіді сервера (201 Created, 200 OK, 204 No Content), що свідчить про коректну реалізацію логіки доступу за ролями.


Рисунок 2.9 – Endpoints для Admin


Рисунок 2.10 – Перевірка роботи для Admin 

     На рисунках 2.11–2.14 наведено endpoint-и для подання заявок на вивіз сміття та керування процесами вивозу.
     

Рисунок 2.11 – Endpoints для подання заявок на вивіз сміття 


Рисунок 2.12 – Перевірка роботи для Requests


Рисунок 2.13 – Endpoints для вивозу сміття 


Рисунок 2.14 – Перевірка роботи для Pickups

     На рисунках 2.15–2.16 представлено endpoint-и модуля аналітики. Під час тестування перевірено формування статистики активності користувачів та організацій. Сервер коректно обробляє аналітичні запити та повертає узагальнені дані у відповідному форматі.
     

Рисунок 2.15 – Endpoints для аналізу активності користувачів


Рисунок 2.16 – Перевірка роботи для Analytics

     На рисунках 2.17–2.18 продемонстровано роботу endpoint-у для формування документу, а саме акту приймання-передачі відходів. Документ формується автоматично на основі даних з бази та повертаються клієнту без помилок, що підтверджує коректність реалізації відповідного бізнес-процесу
     

Рисунок 2.17– Endpoint для формування акту приймання-передачі відходів 


Рисунок 2.18 – Перевірка роботи Documents

     У результаті проведеного тестування встановлено, що всі розроблені функції бізнес-логіки та адміністрування серверної частини програмної системи Ecofy працюють коректно.














ВИСНОВКИ

     У ході виконання даної роботи було розроблено серверну частину програмної системи Ecofy, призначеної для підтримки процесів управління роздільним збором, вивозом та утилізацією відходів із використанням сучасних веб-технологій та IoT-рішень.
     У процесі роботи реалізовано повноцінну бізнес-логіку серверної частини, яка забезпечує обробку HTTP-запитів від мобільних, веб-клієнтів та IoT-пристроїв, виконання CRUD-операцій над даними, контроль доступу на основі ролей користувачів, формування сповіщень, аналітики та звітів, а також дотримання вимог безпеки й цілісності даних. Усі запити до серверної частини проходять обов’язкові етапи автентифікації та авторизації з використанням JWT-токенів, що дозволяє ефективно запобігати несанкціонованому доступу до ресурсів системи.
     Для наочного відображення логіки роботи серверної частини було розроблено UML-діаграми діяльності та послідовності, які відображають основні бізнес-процеси, взаємодію серверних компонентів між собою, з базою даних та IoT-пристроями, а також враховують альтернативні й помилкові сценарії виконання операцій.
     Проведене тестування серверної частини з використанням документації Swagger (OpenAPI) та аналізу логів у середовищі Visual Studio Code підтвердило коректність роботи всіх розроблених endpoint-ів, правильність реалізації бізнес-логіки, механізмів доступу за ролями та взаємодії з базою даних.
     Таким чином, розроблена серверна частина програмної системи Ecofy є придатною для подальшого розширення й інтеграції з IoT-інфраструктурою.





ДОДАТОК А
Відеозапис 
     Відеозапис захисту лабораторної: https://youtu.be/mjGIXg6QiP8

























ДОДАТОК Б
Програмний код

     GitHub репозиторій: https://github.com/NureButAnna/ark-pzpi-23-8-but-anna/tree/main/Task3/ark-pzpi-23-8-but-anna-task3
     Б.1 Код, який перевіряє JWT-токен, визначає роль користувача та повертає відповідний обліковий запис із бази даних.
     
1	def get_current_user(
2	    token: str = Depends(oauth2_scheme),
3	    db: Session = Depends(get_db)
4	):
5	    cred_exc = HTTPException(
6	        status_code=401,
7	        detail="Invalid authentication credentials",
8	        headers={"WWW-Authenticate": "Bearer"},
9	    )
10	
11	    try:
12	        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
13	        entity_id = payload.get("sub")
14	        role = payload.get("role")
15	
16	        if entity_id is None or role is None:
17	            raise cred_exc
18	
19	    except JWTError:
20	        raise cred_exc
21	
22	    if role == "user":
23	        identity = db.query(Users).filter(
24	            Users.user_id == int(entity_id)
25	        ).first()
26	
27	    elif role == "client_company":
28	        identity = db.query(ClientCompanies).filter(
29	            ClientCompanies.client_id == int(entity_id)
30	        ).first()
31	
32	    elif role == "organization":
33	        identity = db.query(Organization).filter(
34	            Organization.organization_id == int(entity_id)
35	        ).first()
36	
37	    elif role == "admin":
38	        identity = db.query(Admins).filter(
39	            Admins.admin_id == int(entity_id)
40	        ).first()
41	
42	    else:
43	        raise cred_exc
44	
45	    if not identity:
46	        raise cred_exc
47	
48	    return identity, role


     GitHub репозиторій: https://github.com/NureButAnna/ark-pzpi-23-8-but-anna/tree/main/Task3/ark-pzpi-23-8-but-anna-task3
     Б.2 Функція для формування статистики активності клієнтських компаній

1 def client_companies_activity_statistic(
2 db: Session = Depends(get_db),
3     current=Depends(get_current_user)
4 ):
5     _, role = current
6     if role != "admin":
7         raise HTTPException(403, "Only admin can view analytics")
8 
9     statistic = (
10         db.query(
11             ClientCompanies.client_id,
12             ClientCompanies.name,
13             func.count(DisposalRequests.request_id).label("total_requests"),
14             func.count(
15                 func.nullif(DisposalRequests.status != "completed", True)
16             ).label("completed_requests"),
17             func.count(
18                 func.nullif(DisposalRequests.status == "completed", True)
19             ).label("active_requests"),
20             func.max(DisposalRequests.created_at).label("last_activity")
21         )
22         .outerjoin(
23             DisposalRequests,
24             DisposalRequests.client_id == ClientCompanies.client_id
25         )
26         .group_by(ClientCompanies.client_id)
27         .all()
28     )
29 
30     return statistic




     GitHub репозиторій: https://github.com/NureButAnna/ark-pzpi-23-8-but-anna/tree/main/Task3/ark-pzpi-23-8-but-anna-task3
     Б.3 Функція формування статистики діяльності організацій, включаючи кількість заявок, контейнерів і майданчиків

1 def organizations_activity_statistic(
2     db: Session = Depends(get_db),
3     current=Depends(get_current_user)
4 ):
5     _, role = current
6     if role != "admin":
7         raise HTTPException(403, "Only admin can view analytics")
8 
9     statistic = (
10         db.query(
11             Organization.organization_id,
12             Organization.name,
13             func.count(DisposalRequests.request_id).label("total_requests"),
14             func.count(
15                 func.nullif(DisposalRequests.status != "completed", True)
16             ).label("completed_requests"),
17             func.count(func.distinct(ContainerSite.container_site_id))
18                 .label("container_sites"),
19             func.count(func.distinct(Containers.container_id))
20                 .label("containers"),
21             func.max(DisposalRequests.updated_at).label("last_activity")
22         )
23         .outerjoin(
24             DisposalRequests,
25             DisposalRequests.organization_id == Organization.organization_id
26         )
27         .outerjoin(
28             ContainerSite,
29             ContainerSite.organization_id == Organization.organization_id
30         )
31         .outerjoin(
32             Containers,
33             Containers.container_site_id == ContainerSite.container_site_id
34         )
35         .group_by(Organization.organization_id)
36         .all()
37     )
38 
39     return statistic


     GitHub репозиторій: https://github.com/NureButAnna/ark-pzpi-23-8-but-anna/tree/main/Task3/ark-pzpi-23-8-but-anna-task3
     Б.4  Функція, яка реалізує формування актів приймання-передачі відходів на основі заявок з урахуванням ролі користувача

1 def get_all_waste_transfer_acts(
2 db: Session = Depends(get_db),
3 current=Depends(get_current_user)
4 ):
5 current_user, role = current

6 query = db.query(DisposalRequests)

7 if role == "admin":
8 pass

9 elif role == "organization":
10 query = query.filter(
11 DisposalRequests.organization_id ==
12 current_user.organization_id
13 )

14 elif role == "client_company":
15 query = query.filter(
16 DisposalRequests.client_id ==
17 current_user.client_id
18 )

19 else:
20 raise HTTPException(403, "Access denied")

21 requests = query.all()

22 acts: list[WasteTransferActDTO] = []

23 for r in requests:
24 if not r.client or not r.organization:
25 continue

26 client = r.client
27 organization = r.organization

28 sender_address = (
29 f"{client.city}, {client.street}, {client.building}"
30 )
31 receiver_address = (
32 f"{organization.city}, {organization.street}, {organization.building}"
33 )

34 transfer_time = r.updated_at or r.created_at

35 acts.append(WasteTransferActDTO(
36 city=organization.city,
37 act_date=transfer_time.date(),

38 sender_name=client.name,
39 sender_edrpou=client.edrpou,
40 sender_address=sender_address,
41 sender_phone=client.phone_number,

42 receiver_name=organization.name,
43 receiver_edrpou=organization.edrpou,
44 receiver_address=receiver_address,
45 receiver_phone=organization.phone_number,

46 transfer_datetime=transfer_time,
47 waste_description=r.waste_description,
48 rejection_reason=None
49 ))

50 return acts



